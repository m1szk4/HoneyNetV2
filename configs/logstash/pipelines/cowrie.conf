# Cowrie Honeypot Logstash Pipeline
# Processes Cowrie SSH/Telnet honeypot logs

input {
  file {
    path => "/input/cowrie/cowrie.json"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/cowrie_sincedb"
    codec => json
    type => "cowrie"
  }
}

filter {
  # Parse Cowrie JSON
  if [type] == "cowrie" {
    # Extract timestamp first
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    # GeoIP lookup BEFORE anonymization
    if [src_ip] {
      geoip {
        source => "src_ip"
        target => "geoip"
        fields => ["country_code2"]
        tag_on_failure => ["_geoip_lookup_failure"]
      }

      # Extract country code
      if [geoip][country_code2] {
        mutate {
          add_field => { "source_ip_country" => "%{[geoip][country_code2]}" }
        }
      } else {
        mutate {
          add_field => { "source_ip_country" => "" }
        }
      }
    }

    # Anonymize source IP AFTER GeoIP
    ruby {
      code => '
        require "digest"
        salt = ENV["ANON_SALT"] || "default_salt"
        if event.get("src_ip")
          hashed_ip = Digest::SHA256.hexdigest(salt + event.get("src_ip").to_s)
          event.set("source_ip_hash", hashed_ip[0..15])
        end
      '
    }

    # Normalize event types
    if [eventid] == "cowrie.login.success" {
      mutate { add_field => { "event_type" => "login_success" } }
    } else if [eventid] == "cowrie.login.failed" {
      mutate { add_field => { "event_type" => "login_failed" } }
    } else if [eventid] == "cowrie.command.input" {
      mutate { add_field => { "event_type" => "command" } }
    } else if [eventid] == "cowrie.session.file_download" {
      mutate { add_field => { "event_type" => "file_download" } }
    } else if [eventid] == "cowrie.session.connect" {
      mutate { add_field => { "event_type" => "session_start" } }
    } else if [eventid] == "cowrie.session.closed" {
      mutate { add_field => { "event_type" => "session_end" } }
    } else {
      mutate { add_field => { "event_type" => "other" } }
    }

    # Add honeypot type
    mutate {
      add_field => { "honeypot_type" => "cowrie" }
    }

    # Remove original IP and temporary fields
    mutate {
      remove_field => ["src_ip", "geoip"]
    }
  }
}

output {
  # Main events table
  http {
    url => "http://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/?query=INSERT%20INTO%20${CLICKHOUSE_DB}.honeypot_events%20FORMAT%20JSONEachRow"
    http_method => "post"
    format => "json_batch"
    content_type => "application/json"
    automatic_retries => 3
    retry_non_idempotent => true
    mapping => {
      "timestamp" => "%{@timestamp}"
      "event_id" => "%{session}"
      "honeypot_type" => "cowrie"
      "source_ip_hash" => "%{source_ip_hash}"
      "source_ip_country" => "%{source_ip_country}"
      "source_port" => "%{src_port}"
      "dest_ip" => "%{dst_ip}"
      "dest_port" => "%{dst_port}"
      "protocol" => "%{protocol}"
      "event_type" => "%{event_type}"
      "username" => "%{username}"
      "password" => "%{password}"
      "command" => "%{input}"
      "session_id" => "%{session}"
      "success" => "%{[eventid] == 'cowrie.login.success'}"
      "raw_data" => "%{message}"
    }
  }

  # Credentials table
  if [username] and [password] {
    http {
      url => "http://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/?query=INSERT%20INTO%20${CLICKHOUSE_DB}.credentials%20FORMAT%20JSONEachRow"
      http_method => "post"
      format => "json_batch"
      content_type => "application/json"
      mapping => {
        "timestamp" => "%{@timestamp}"
        "source_ip_hash" => "%{source_ip_hash}"
        "honeypot_type" => "cowrie"
        "protocol" => "%{protocol}"
        "username" => "%{username}"
        "password" => "%{password}"
        "success" => "%{[eventid] == 'cowrie.login.success'}"
        "session_id" => "%{session}"
      }
    }
  }

  # Downloaded files table
  if [eventid] == "cowrie.session.file_download" {
    http {
      url => "http://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/?query=INSERT%20INTO%20${CLICKHOUSE_DB}.downloaded_files%20FORMAT%20JSONEachRow"
      http_method => "post"
      format => "json_batch"
      content_type => "application/json"
      mapping => {
        "timestamp" => "%{@timestamp}"
        "file_id" => "%{shasum}"
        "source_ip_hash" => "%{source_ip_hash}"
        "honeypot_type" => "cowrie"
        "filename" => "%{filename}"
        "file_size" => "%{size}"
        "mime_type" => ""
        "md5_hash" => ""
        "sha1_hash" => ""
        "sha256_hash" => "%{shasum}"
        "download_url" => "%{url}"
        "file_path" => "%{outfile}"
      }
    }
  }

  # Debug output (optional)
  # stdout { codec => rubydebug }
}
