# Conpot ICS/SCADA Honeypot Logstash Pipeline
# Processes Conpot industrial control system honeypot logs

input {
  file {
    path => "/input/conpot/conpot.json"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/conpot_sincedb"
    codec => json
    type => "conpot"
  }
}

filter {
  if [type] == "conpot" {
    # Anonymize source IP
    ruby {
      code => '
        require "digest"
        salt = ENV["ANON_SALT"] || "default_salt"
        if event.get("remote") && event.get("remote")[0]
          ip = event.get("remote")[0]
          hashed_ip = Digest::SHA256.hexdigest(salt + ip.to_s)
          event.set("source_ip_hash", hashed_ip[0..15])
          event.set("source_port", event.get("remote")[1])
        end
      '
    }

    # Parse timestamp
    date {
      match => ["timestamp", "ISO8601", "UNIX"]
      target => "@timestamp"
    }

    # Extract protocol and event type
    if [data_type] {
      mutate {
        add_field => { "protocol" => "%{data_type}" }
      }
    }

    # Determine event type based on request type
    if [request] {
      mutate {
        add_field => { "event_type" => "request" }
      }
    } else {
      mutate {
        add_field => { "event_type" => "connection" }
      }
    }

    # Add honeypot type
    mutate {
      add_field => { "honeypot_type" => "conpot" }
    }

    # Remove original IP
    mutate {
      remove_field => ["remote"]
    }
  }
}

output {
  # Main events table
  http {
    url => "http://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/?query=INSERT%20INTO%20${CLICKHOUSE_DB}.honeypot_events%20FORMAT%20JSONEachRow"
    http_method => "post"
    format => "json_batch"
    content_type => "application/json"
    automatic_retries => 3
    mapping => {
      "timestamp" => "%{@timestamp}"
      "event_id" => "%{id}"
      "honeypot_type" => "conpot"
      "source_ip_hash" => "%{source_ip_hash}"
      "source_ip_country" => ""
      "source_port" => "%{source_port}"
      "dest_ip" => ""
      "dest_port" => "%{[public_ip][1]}"
      "protocol" => "%{protocol}"
      "event_type" => "%{event_type}"
      "username" => ""
      "password" => ""
      "command" => "%{request}"
      "session_id" => "%{session_id}"
      "success" => "false"
      "raw_data" => "%{message}"
    }
  }

  # Debug output (optional)
  # stdout { codec => rubydebug }
}
